---
title: "Single sample vs. others"
author: "Jim Zhang"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: true
---

<div style="background-color:rgba(0, 0, 0, 0.025); font-size:1.5em; padding:40px 0">
**Introduction**: Compare one sample to all the others to identify sample-specific differential expression.
</div>

```{r global_setup, include=FALSE}
knitr::opts_chunk$set(dpi=300, dev=c('png', 'pdf'), fig.pos="H", fig.width=8, fig.height=6, echo=FALSE, warning=FALSE, message=FALSE);

require(yaml);
require(knitr);
require(RankProd);
require(DEGandMore);
require(awsomics);
require(rchive);

#fn.yaml<-"/nas/is1/zhangz/projects/curran/2015-08_Resistant_Medulloblastoma/result/one_vs_others/one_vs_others.yml";
#yml<-yaml.load_file(fn.yaml);

expr<-readRDS(yml$input$data); 
anno<-readRDS(yml$input$annotation); 
gset<-readRDS(yml$input$geneset); 
path<-yml$output; 
  
if (!file.exists(path)) dir.create(path, recursive=TRUE); 

path.fc<-paste(path, 'fc', sep='/');
if (!file.exists(path.fc)) dir.create(path.fc, recursive=TRUE); 

path.rp<-paste(path, 'rp', sep='/');
if (!file.exists(path.rp)) dir.create(path.rp, recursive=TRUE); 

path.ora<-paste(path, 'ora', sep='/');
if (!file.exists(path.ora)) dir.create(path.ora, recursive=TRUE); 

path.r<-paste(path, 'R', sep='/');
if (!file.exists(path.r)) dir.create(path.r, recursive=TRUE); 

path.tbl<-paste(path, 'table', sep='/');
if (!file.exists(path.tbl)) dir.create(path.tbl, recursive=TRUE); 

if (is.null(yml$home)) home.url<-'' else 
  home.url<-paste("<div align='right'>**_[Go back to project home](", yml$home, ")_**</div>", sep='');


anno<-anno[rownames(anno) %in% rownames(expr), ];
expr<-expr[rownames(anno), ];

anno0<-anno;
anno0$Symbol<-CleanHtmlTags(anno0$Symbol, FALSE);

write.csv(anno0, paste(path.tbl, 'anno.csv', sep='/')); 
write.csv(expr, paste(path.tbl, 'expr.csv', sep='/')); 
saveRDS(anno, paste(path.r, 'anno.rds', sep='/')); 
saveRDS(expr, paste(path.r, 'expr.rds', sep='/')); 
```

`r home.url`

# Description

```{r description, eval=TRUE, include=FALSE}

lns<-lapply(names(yml$description), function(nm) {
  c(paste('##', nm), '\n', yml$description[[nm]], '\n'); 
});
lns<-paste(do.call('c', lns), collapse='\n'); 
```

`r lns`

`r home.url`

# Sample analysis

<div align='center'>
```{r cluster, fig.width=8, fig.height=6, out.width='600px'}
hc<-hclust(as.dist(1-cor(expr))); 
par(mar=c(2,5,3,2));
plot(hc, main='Unsupervised clustering', cex.main=2, cex.lab=2, ylab='Sample-sample distance', xlab='', sub=''); 
```
</div>

**Figure 1** Unsupervised sample clustering using all genes.

<div align='center'>
```{r range, fig.width=8, fig.height=6, out.width='600px'}
rng<-t(apply(expr, 1, range));
par(mar=c(5,5,2,2)); 
hist(rng[, 2]-rng[, 1], xlab='Max - Min', ylab='Number of genes', cex.lab=2, main='Data range', cex.main=2);
```
</div>

**Figure 2** The distribution of gene-level data range. Range of each gene is the difference between its maximal and minimal values.

`r home.url`
 
# Differential expression

## Fold change

Calculate the difference between each sample to the mean of all the other `r ncol(expr)-1` samples. 

```{r def, include=FALSE}
# Plot scatter plots
fn<-sapply(colnames(expr), function(nm) {
  x<-cbind(expr[, nm], rowMeans(expr[, !(colnames(expr) %in% nm)])); 
  f<-paste(path.fc, paste(nm, '_vs_others.pdf', sep=''), sep='/'); 
  pdf(f, w=6, h=6); 
  par(mar=c(5, 5, 2, 2)); 
  plot(x, xlim=range(x), ylim=range(x), xlab=nm, ylab='Mean of other samples', cex.lab=2, col='#88888888', pch=19, cex=0.5); 
  abline(0, 1, col='blue', lwd=2, lty=2); 
  dev.off(); 
  f; 
}); 

fc<-sapply(1:ncol(expr), function(i) expr[, i]-rowMeans(expr[, -i])); 
#nsd<-sapply(1:9, function(i) (expr[, i]-rowMeans(expr[, -i]))/apply(expr[, -i], 1, sd)); 
colnames(fc)<-colnames(expr); 
mx<-apply(fc, 2, max);
mn<-apply(fc, 2, min);
n1<-sapply(-yml$parameter$fold:-1, function(c) apply(fc, 2, function(d) length(d[d<=c]))); 
n2<-sapply(yml$parameter$fold:1, function(c) apply(fc, 2, function(d) length(d[d>=c]))); 
ct<-cbind(n1, n2);
rownames(ct)<-colnames(expr);
cnm1<-paste(-round(exp(yml$parameter$fold:1*log(2))), 'fold', 'down', sep='_');
cnm2<-paste(round(exp(yml$parameter$fold:1*log(2))), 'fold', 'up', sep='_');
colnames(ct)<-c(cnm1, cnm2);
ct<-cbind(Sample= paste('[', rownames(ct), '](fc/', colnames(expr), '_vs_others.pdf)', sep=''), ct); 

t<-FormatNumeric(fc); 
t<-cbind(t, anno[rownames(t), ]); 
saveRDS(t, file=paste(path.r, 'fold_change.rds', sep='/'));
CreateDatatable(t, paste(path.fc, 'fold_change.html', sep='/')); 

t[, colnames(anno0)]<-anno0; 
write.csv(t, file=paste(path.tbl, 'fold_change.csv', sep='/'));
```

**Table 1** Number of genes with different cutoffs of folder changes: 

`r kable(ct, row.names=FALSE)`

Click [here](fc/fold_change.html) to veiw full table.

`r home.url`

## Rank product test

Genes were ranked for each sample using the [rank product](https://en.wikipedia.org/wiki/Rank_product) method. Inputs to the analysis were the fold change between the sample and each of the other samples.

```{r rank_product, include=FALSE}
fn.rp<-paste(path.r, 'rank_product.rds', sep='/'); 
if (file.exists(fn.rp)) rp<-readRDS(fn.rp) else {
  d<-lapply(1:ncol(expr), function(i) expr[, i]-expr[, -i]);
  cl<-rep(1, ncol(expr)-1);
  rp<-lapply(d, function(d) RP(d, cl));
  names(rp)<-colnames(expr); 
  saveRDS(rp, file=fn.rp);
}
summ.rp<-lapply(names(rp), function(nm) {
  summ<-SummarizeRP(rp[[nm]], nm, 'others', save.it = FALSE);
  names(summ)<-paste(c('Lower', 'Higher'), 'in', nm, sep='_'); 
  summ; 
});
names(summ.rp)<-names(rp); 
sapply(names(summ.rp), function(nm) {
  saveRDS(summ.rp[[nm]], paste(path.r, paste('RP_', nm, '.rds', sep=''), sep='/'));
  x<-summ.rp[[nm]]; 
  sapply(names(x), function(nm1) {
    t<-x[[nm1]];
    t<-cbind(t, anno0[rownames(t), ]); 
    write.csv(t, paste(path.tbl, paste('RP_', nm1, '.csv', sep=''), sep='/')); 
  })->x;
})->x; 
gn<-lapply(summ.rp, function(x) lapply(x, function(y) rownames(y)[y[,1]<=yml$parameter$top]))
p<-lapply(summ.rp, function(x) lapply(x, function(y) y[, 5]));
q<-lapply(summ.rp, function(x) lapply(x, function(y) y[, 6]));
names(gn)<-names(rp);

tbl<-sapply(names(gn), function(nm1) sapply(names(gn[[nm1]]), function(nm2) {  cat(nm1, '\t', nm2, '\n'); 
  f<-paste(nm2, '.html', sep=''); 
  t<-summ.rp[[nm1]][[nm2]];
  t<-t[gn[[nm1]][[nm2]], ]; 
  t<-FormatNumeric(t[order(t[, 1]), ]);
  t<-cbind(anno[rownames(t), ], t, FormatNumeric(expr[rownames(t), ])); 
  CreateDatatable(t, paste(path.rp, f, sep='/'), caption=nm2); 
  d<-expr[rownames(t), ]; 
  d<-d-rowMeans(d[, !(colnames(d) %in% nm1)]);
  d<-t(apply(d, 1, function(d) d/sd(d))); 
  d<-d[hclust(as.dist(1-cor(t(d))))$order, ]; 
  f1<-sub('.html$', '.pdf', f); 
  pdf(paste(path.rp, f1, sep='/'), w=6, h=8);
  PlotColoredBlock(d, num.breaks = 63, key='Normalized expression', groups=as.list(names(gn))); 
  dev.off(); 
  cll<-paste('[', c('gene', 'heatmap'), '](rp/', c(f, f1), ')', sep=''); 
  paste(cll, collapse='; '); 
})); 
tbl<-t(tbl);
colnames(tbl)<-c('Lower_than_the_others', 'Higher_than_the_others'); 
```

**Table 2** Top ranked `r yml$parameter$top` genes by rank product analysis. Click the links to view gene list and a heatmap made using these genes.

`r kable(tbl)`

`r home.url`

## Gene set over-representation analysis

```{r ora, include=FALSE}
gs.src<-sort(unique(gset[[1]][, 'Source']));
tbl<-sapply(names(gn), function(nm) {
  cat(nm, '\n');
  g<-gn[[nm]];
  names(g)<-c('Lower', 'Higher');
  out<-lapply(names(g), function(nm1) {
    stat<-TestGSE(g[[nm1]], rownames(anno), gset[[2]])[[1]]; 
    ora<-WrapGSE(stat, gset[[1]], paste(path.ora, paste(nm1, nm, sep='_'), sep='/'), FALSE); 
    saveRDS(ora, file=paste(path.r, paste('ORA_', nm1, '_', nm, '.rds', sep=''), sep='/'));
    sapply(names(ora$formatted), function(nm2) {
      t<-ora$formatted[[nm2]];
      t$Name<-CleanHtmlTags(t$Name, FALSE); 
      write.csv(t, paste(path.tbl, paste('ORA_', nm1, '_', nm2, '_', nm, '.csv', sep=''), sep='/')); 
    })->x; 
    cnt<-sapply(ora[[2]], nrow); 
    url<-AddHref(cnt, sub(paste(path, '/', sep=''), '', ora[[3]])); 
    names(url)<-names(cnt);
    url<-url[gs.src];
    url[is.na(url)]<-'0';
    names(url)<-gs.src;
    url; 
  }); 
  out; 
}); 

tbl.hi<-do.call('rbind', tbl[1, ]); 
tbl.lo<-do.call('rbind', tbl[2, ]); 
```

**Table 3A** Gene set over-represented in the top `r yml$parameters$top` genes with higher expression in a single sample comparing to the others

`r kable(tbl.hi)`

**Table 3B** Gene set over-represented in the top `r yml$parameters$top` genes with lower expression in a single sample comparing to the others

`r kable(tbl.lo)`

`r home.url`

***
**END_OF_DOCUMENT**

