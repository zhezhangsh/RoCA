---
title: "Run Principal Components Analysis (PCA) and plot results"
author: "`r if (exists('yml')) yml$analyst else 'Jim Zhang'`"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
    self_contained: no
    toc: yes
    toc_float:
      collapsed: no
---

<div style="border:black 1px solid; padding: 0.5cm 0.5cm">
This procedure runs Principal Components Analysis (PCA) for quality control and sample analysis purposes. It uses a data matrix of variables (rows) and samples (columns), such as a normalized transcriptome data set, as input, and plots results based on one or multipel sample characteristics, . 
</div>

&nbsp;

```{r global_setup, eval=TRUE, include=FALSE}
name.yaml <- 'run_pca.yaml'; 
name.packages <- c('rmarkdown', 'knitr', 'kableExtra', 'yaml', 'DT', 'htmlwidgets', 'awsomics', 'gplots'); 
name.subfolders <- c('path.input'='input', 'path.r'='R', 'path.fig'='figure', 'path.tbl'='table'); # <full.path.to.subfolder>=<subfolder.name>

## Default knitr parameters
knitr::opts_chunk$set(dpi=300, dev=c('png', 'pdf'), echo=FALSE, warning=FALSE, message=FALSE, fig.path = 'figure/');
if (!require(devtools)) { install.packages('devtools'); require(devtools); }
if (!require(RCurl)) { install.packages('RCurl'); require(RCurl); }
if (!require(RoCA)) { install_github('zhezhangsh/RoCAR'); require(RoCA); }

## Load required R packages
loaded <- LoadPackage(name.packages);
if (length(loaded[!loaded])) stop('Error: failed to load package(s) ', paste(names(loaded[!loaded]), collapse=', '));

## By default, before knitting this R Markdown file, the YAML file pairing it has been loaded.
## But, the developer can also provide the option to load the YAML file on the fly.
## So, the template can be run using the "Knit HTML" button in RStudio
if (!exists('yml'))                   # if the 'yml' variable doesn't exist yet, create it by loading the YAML file
  if (file.exists(name.yaml))         # assume the pairing YAML file exists in the current folder with the same name
    yml<-yaml.load_file(name.yaml);   # rename the YAML file to fit this template

prms <- yml$parameter;

## Generate directory and sub-directories where the output files will be
f <- GenerateFolder(yml$output, name.subfolders);
path <- yml$output;
for (i in 1:length(name.subfolders)) assign(names(name.subfolders)[i], f[name.subfolders[i]]); 

## Automatical figure/table ordering
OrderFigure(reset=TRUE);
OrderTable(reset=TRUE);

## URL to project home
## Use this line to add a link to project home in the report: `r home.url`
home.url <- Link2Home(yml$home);
```

`r home.url` 

# Description {.tabset}

`r WriteDescription(yml$description)`

```{r load_data, include=FALSE}
mtrx <- ImportTable(DownloadFile(yml$input$data, path.input));
smpl <- ImportTable(DownloadFile(yml$input$sample, path.input));

smpl <- smpl[rownames(smpl) %in% colnames(mtrx), , drop=FALSE];
mtrx <- mtrx[, rownames(smpl), drop=FALSE];

write.csv(smpl, paste(path.tbl, 'sample.csv', sep='/'));

# Filter by missing values
fil.ms <- as.integer(prms$filter$missing[1]);
if (fil.ms == 0 | is.na(fil.ms) | is.null(fil.ms)) mtrx <- mtrx[!is.na(rowMeans(mtrx)), , drop=FALSE] else 
  for (i in 1:ncol(mtrx)) {
    d <- mtrx[, i];
    d[is.na(d)] <- rowMeans(mtrx[, -i, drop=FALSE], na.rm = TRUE); # replace with mean of other samples
    d[is.na(d)] <- mean(mtrx, na.rm=TRUE); # replace with global mean
    mtrx[, i] <- d; 
  }

# Filter by variable means
fil.mn <- as.numeric(prms$filter$mean[1]);
if (!is.null(fil.mn) & length(fil.mn)>0) if (!is.na(fil.mn)) 
  mtrx <- mtrx[rowMeans(mtrx)>=fil.mn, , drop=FALSE]; 

# Filter by nsd/outlier
fil.sd <- as.numeric(prms$filter$nsd);
if (!is.null(fil.sd) & length(fil.sd)>0) if (!is.na(fil.sd)) {
  nsd <- sapply(1:ncol(mtrx), function(i) abs(mtrx[, i]-mean(mtrx[, -i]))/apply(mtrx[, -i, drop=FALSE], 1, sd));
  mtrx <- mtrx[apply(nsd, 1, max)<=fil.sd, , drop=FALSE];
}; 

if (nrow(mtrx) < 3) stop("Error: cannot proceed with this analysis with less than 3 variables\n"); 
if (ncol(mtrx) < 3) stop("Error: cannot proceed with this analysis with less than 3 samples\n"); 
```

`r home.url`

# Analysis and results

## Run PCA

Principal Components Analysis is run on **`r nrow(mtrx)`** variables and **`r ncol(mtrx)`** samples.

### Variance proportion

Total variance contributed by each PC.

```{r run_pca, include=FALSE}
pca <- prcomp(t(mtrx));
smm <- summary(pca)$importance; 
cov <- pca$x;
ldg <- pca$rotation;

saveRDS(pca, paste(path.r, 'pca.rds', sep='/'));

write.csv(ldg, paste(path.tbl, 'pca_loading.csv', sep='/'));
CreateDatatable(FormatNumeric(pca$rotation), paste(path.tbl, 'pca_loading.html', sep='/'));

write.csv(smm, paste(path.tbl, 'pca_summary.csv', sep='/'));
CreateDatatable(FormatNumeric(smm), paste(path.tbl, 'pca_summary.html', sep='/'));

write.csv(cov, paste(path.tbl, 'pca_covariance.csv', sep='/'));
CreateDatatable(FormatNumeric(cov), paste(path.tbl, 'pca_covariance.html', sep='/'));

wid <- max(4.8, min(8, 0.5*ncol(mtrx)));
pix <- paste0(100*wid, 'px');

tbl <- cov[, 1:min(8, ncol(cov))];
```

```{r variance_proportion, include=TRUE, fig.height=5.6, fig.width=wid, out.width=pix}
par(mar=c(5,5,2,2));
plot(1:ncol(smm), 100*smm[3, ], type='b', xlim=c(1, ncol(smm)), xaxs='i', ylim=c(0, 100), yaxs='i',
     xaxt='n', ylab='Cumulative proportion of total variance (%)', xlab='', cex.lab=1.25, 
     col='#E74C3C', lwd=1.5, cex=0.75, pch=16);
axis(1, at=1:ncol(smm), label=paste0('PC', 1:ncol(smm)), las=3, cex.axis=min(1.25, 36/ncol(smm)));
```

`r OrderFigure()` Cummulative variance contributed by ordered PCs. Click link below to view full table:

>[PCA summary](table/pca_summary.html) ([Download](table/pca_summary.csv))

`r home.url`

### Sample covariance

Covariance of each PC by samples.

`r OrderTable()` Sample covariance of first `r ncol(tbl)` PCs. Click link below to view all PCs.

>[Full covariance table](table/pca_covariance.html) ([Download](table/pca_covariance.csv))

`r kable(FormatNumeric(tbl)) %>% kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width=FALSE)`

```{r sample_covariance, include=TRUE, fig.width=wid, fig.height=6, out.width=pix}
par(mar=c(5,5,2,2));
bxp <- boxplot(cov, pch=18, cex=1, col='#3498DB', ylab='Sample covariance', 
               cex.lab=1.25, xaxt='n');
axis(1, at=1:ncol(smm), label=paste0('PC', 1:ncol(smm)), las=3, cex.axis=min(1.25, 36/ncol(smm)));

o1 <- sapply(1:ncol(cov), function(i) {
  x <- bxp$stats[, i]; 
  y <- cov[, i];
  z <- y[y<x[1] | y>x[length(x)]];
  f <- paste0('sample_pc', i, '.csv');
  write.table(cbind(names(z), z), sep='\t', qu=FALSE, row=FALSE, col=FALSE, paste(path.tbl, f, sep='/'));
  length(z);
}); 
l1 <- AddHref(o1, paste0('sample_pc', 1:ncol(cov), '.csv'));
```

`r OrderFigure()` Distribution of sample covariance by PCs. Outliers were drawn beyond the boxes. Click link below to see individual outliers. 

>[Download outlier samples](table/download.html)

`r home.url`

### Variable loading

Loading (weight) of variables on each PC.

>[Full variable loading table](table/pca_loading.html) ([Download](table/pca_loading.csv))

```{r variable_loading, include=TRUE, fig.width=wid, fig.height=6, out.width=pix}
par(mar=c(5,5,2,2));
bxp <- boxplot(ldg, pch=19, cex=1/3, col='#E74C3C', ylab='Variable loading', 
               cex.lab=1.25, xaxt='n');
axis(1, at=1:ncol(smm), label=paste0('PC', 1:ncol(smm)), las=3, cex.axis=min(1.25, 36/ncol(smm)));

o2 <- sapply(1:ncol(cov), function(i) {
  x <- bxp$stats[, i]; 
  y <- ldg[, i];
  z <- y[y<x[1] | y>x[length(x)]];
  f <- paste0('variable_pc', i, '.csv');
  write.table(cbind(names(z), z), sep='\t', qu=FALSE, row=FALSE, col=FALSE, paste(path.tbl, f, sep='/'));
  length(z); 
}); 
l2 <- AddHref(o2, paste0('variable_pc', 1:length(o2), '.csv'));
```

`r OrderFigure()` Distribution of variable loading by PCs. Outliers drawn beyond the boxes are variables with high contribution to each PC. Click link below to see individual outliers. 

>[Downlaod high loading variables](table/download.html)

`r home.url`

### Remove PC

In case a PC is obviously related to a confounder, such as batch effect and gender, its impact can be removed by calculating the residuals of a linear fitting between each variable and each PC. A residual matrix is generated corresponding to the removal of each PC. 

```{r remove_pc}
res <- lapply(1:ncol(cov), function(i) {
  x <- cov[, i];
  y <- apply(mtrx, 1, function(z) residuals(lm(z ~ x)));
  z <- t(y); 
  write.csv(z, paste0(path.tbl, '/residual_pc', i, '.csv'));
  z; 
});
names(res) <- paste('PC', 1:length(res));
saveRDS(res, paste(path.r, 'residual.rds', sep='/'));

tbl <- data.frame(Outlier_Sample=l1, High_Loading_Variable=l2,
                  Residual_Matrix=AddHref('residual', paste0('residual_pc', 1:length(l1), '.csv')),
                  stringsAsFactors = FALSE);
tbl <- cbind(t(smm), tbl); 
rownames(tbl) <- paste0('PC', 1:nrow(tbl));
CreateDatatable(tbl, paste(path.tbl, 'download.html', sep='/'), caption = 'Click link to download list') -> x;
```

>[Download residual matrix](table/download.html)

`r home.url`

## Plot PCA {.tabset}

Plot covariance of **`r paste0('PC', prms$plot$dimension[1])`** and **`r paste0('PC', prms$plot$dimension[2])`** and color samples by their characteristics.

```{r plot_pca, include=FALSE}
smp <- smpl[, !(colnames(smpl) %in% prms$exclude), drop=FALSE];
smp <- cbind(ID=rownames(smp), smp); 

plt <- prms$plot;
col <- plt$color;
col <- lapply(col, function(c) pmax(0, pmin(1, c)));
col <- sapply(1:3, function(i) rgb(col[[1]][i], col[[2]][i], col[[3]][i]));

shp <- tolower(prms$plot$shape[1]);
pch <- 19;
if (shp=='square') pch <- 15 else if (shp=='triangle') pch <- 17 else if (shp=='diamond') pch <- 18;

fns <- sapply(colnames(smp), function(nm) { 
  fn <- paste(path.fig, paste('pca_', nm, '.png', sep=''), sep='/');
  png(fn, w=1200, h=900); 
  cex <- min(4, max(0.5, 200/nrow(smp))); 
  cnm <- length(unique(smp[, nm]));
  if (cnm==1) col <- col[1] else 
    if (cnm==2) col<-col[c(1, length(col))] else 
      col <- colorpanel(length(unique(smp[, nm])), col[1], col[2], col[3]);
  names(col) <- unique(smp[, nm]); 
  col <- col[as.character(smp[, nm])]; 
  PlotPCA(pca, groups=smp[, nm], new.window = FALSE, cex=cex, col=col, label=1:nrow(smp), 
          legend=TRUE, legend.single = TRUE, dimensions = c(plt$dimension[1], plt$dimension[2])); 
  if (dev.cur()!=1) dev.off(); 
  fn; 
}); 
fns <- paste('figure', TrimPath(fns), sep='/'); 

lns <- paste(paste('###', colnames(smp)), '\n\n', paste('![](', fns, ')', sep=''), '\n\n', collapse='');
```

`r lns`

## Sample characteristics

`r OrderTable()` Full sample characteristics ([download](table/sample.csv)).

`r kable(smpl) %>% kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width=FALSE)`

`r home.url`

***

# Appendix 

Check out the **[RoCA home page](http://zhezhangsh.github.io/RoCA)** for more information.  

## Reproduce this report

To reproduce this report: 

1. Find the data analysis template you want to use and an example of its pairing YAML file  [here](https://github.com/zhezhangsh/RoCA/wiki/Templates-and-examples) and download the YAML example to your working directory

2. To generate a new report using your own input data and parameter, edit the following items in the YAML file:

- _output_        : where you want to put the output files
- _home_          : the URL if you have a home page for your project
- _analyst_       : your name
- _description_   : background information about your project, analysis, etc.
- _input_         : where are your input data, read instruction for preparing them
- _parameter_     : parameters for this analysis; read instruction about how to prepare input data

3. Run the code below within ***R Console*** or ***RStudio***, preferablly with a new R session:

```{r reproduce_report, eval=FALSE, echo=TRUE}
if (!require(devtools)) { install.packages('devtools'); require(devtools); }
if (!require(RCurl)) { install.packages('RCurl'); require(RCurl); }
if (!require(RoCA)) { install_github('zhezhangsh/RoCAR'); require(RoCA); }

CreateReport(filename.yaml);  # filename.yaml is the YAML file you just downloaded and edited for your analysis
```

If there is no complaint, go to the _output_ folder and open the ***index.html*** file to view report. 

## Session information

```{r session_info, echo=FALSE}
sessionInfo(); 
```

`r home.url`

***
_END OF DOCUMENT_
