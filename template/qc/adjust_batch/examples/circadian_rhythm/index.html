<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Zhe Zhang" />

<meta name="date" content="2016-06-07" />

<title>Analysis and adjustment of batch effect</title>

<script src="index_files/jquery-1.11.3/jquery.min.js"></script>
<script src="index_files/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="index_files/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="index_files/tocify-1.9.1/jquery.tocify.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="index_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="index_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="index_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="index_files/bootstrap-3.3.5/shim/respond.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="index_files/highlight/default.css"
      type="text/css" />
<script src="index_files/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<div class="container-fluid main-container">

<!-- tabsets -->
<script src="index_files/navigation-1.0/tabsets.js"></script>
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.9em;
  padding-left: 5px;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
  padding-left: 10px;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Analysis and adjustment of batch effect</h1>
<h4 class="author"><em>Zhe Zhang</em></h4>
<h4 class="date"><em>2016-06-07</em></h4>

</div>


<div style="border:black 1px solid; padding: 0.5cm 0.5cm">
<p><strong>Introduction: </strong> This analysis applies the Bioconductor <strong><em><a href="https://bioconductor.org/packages/release/bioc/html/sva.html">SVA</a></em></strong> (Surrogate Variable Analysis) package and other methods to evaluate and adjust for known or unknown batch effect. It includes the following steps:</p>
<ul>
<li>This analysis requires an original data matrix and sample description with one or multiple features, and parameters including
<ul>
<li>One or multiple features as variable(s) of interest</li>
<li>Zero or one feature known to be the source of batch effect</li>
<li>The number of surrogate variables (default=5) to be identified from the data matrix</li>
</ul></li>
<li>The <em>sva</em> function will first identify the given number of surrogate variables, each accounting for a portion of the total data variation. These surrogate variables will be evaluated as below.
<ul>
<li>The association between each sample feature and each surrogate variable will be evaluated by ANOVA (categoral feature) or Pearson’s correlation (numeric feature)</li>
<li>By grouping samples according variable(s) of interest, 2 sets of 1-way ANOVA p values, using the data matrix and the matrix adjusted for all surrogate variables, will be compared to evaluate whether removing potential batch effect will improve the signal/noise ratio in the data set.</li>
</ul></li>
<li>A new data matrix will be generated after adjusting for batch effect.
<ul>
<li>If a sample feature is known to be the source of batch effect, the original matrix will be adjusted for it using <strong><em><a href="combat%20batch%20effect%20correction">ComBat</a></em></strong> (categoral variable) or <strong><em><a href="http://bioinf.wehi.edu.au/limma/">limma</a></em></strong> (continuous variable). It will be adjusted for all surrogate variables instead otherwise.</li>
<li>Same as the last step, the impact of data adjustment will be evaluated with 1-way ANOVA of samples grouped by variable(s) of interest.</li>
</ul></li>
<li>An extra step will be carried out to adjust the original data matrix for all sample features and surrogate variables one by one, and evaluate the consequence.</li>
</ul>
</div>
<p> </p>
<div align="right">
<em><a href="http://zhezhangsh.github.io/RoCA">Go to project home</a></em>
</div>
<div id="description" class="section level1">
<h1><span class="header-section-number">1</span> Description</h1>
<div id="project" class="section level2">
<h2><span class="header-section-number">1.1</span> Project</h2>
<p>Perturbed rhythmic activation of signaling pathways in mice deficient for Sterol Carrier Protein 2-dependent diurnal lipid transport and metabolism. (<strong><a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE67426">GSE67426</a></strong>)</p>
</div>
<div id="pubmed" class="section level2">
<h2><span class="header-section-number">1.2</span> PubMed</h2>
<p>Jouffe C, Gobet C, Martin E, Métairon S et al. Perturbed rhythmic activation of signaling pathways in mice deficient for Sterol Carrier Protein 2-dependent diurnal lipid transport and metabolism. Sci Rep 2016 Apr 21;6:24631. PMID: <a href="http://www.ncbi.nlm.nih.gov/pubmed/27097688">27097688</a>.</p>
</div>
<div id="experimental-design" class="section level2">
<h2><span class="header-section-number">1.3</span> Experimental design</h2>
<p>Comparison of liver mRNA expression from Scp2 KO and wild-type mice harvested every 2 hours during 3 consecutive days.</p>
</div>
<div id="analysis" class="section level2">
<h2><span class="header-section-number">1.4</span> Analysis</h2>
<p>This analysis evaluates the potential batch effect of different days, a sample feature named <strong><em>Replicate</em></strong>, on which the mice were harvested. Only the wildtype mice and a subset of genes with high between sample variance were used for demonstration.</p>
<div align="right">
<em><a href="http://zhezhangsh.github.io/RoCA">Go to project home</a></em>
</div>
</div>
</div>
<div id="samples-and-variables-of-interest" class="section level1">
<h1><span class="header-section-number">2</span> Samples and variable(s) of interest</h1>
<p>A total of 36 samples and 3 sample features was provided by the input data. Click <a href="html/sample.html">here</a> to see a full list of samples and samples features.</p>
<ul>
<li>Sample feature(s) to be studied by this project (variables of interest): <strong><em>Group</em></strong></li>
<li>Sample feature with potential batch effect: <strong><em>Replicate</em></strong></li>
<li>All other known sample feature(s): <strong><em>Hour</em></strong></li>
</ul>
<div style="color:darkblue; padding:0 2cm">
<strong>Table 1</strong> All sample features provided by the input data, which could include 1 or many variables of interest and 0 or 1 confounding variable known to be responsible for the batch effect in data. (<strong>Sample_feature:</strong> all sample features given in the input data; <strong>Num_level:</strong> number of unique values of each sample feature; <strong>Variable_of_interest:</strong> whether this sample feature is a variable of interest in this project; and <strong>Batch_effect</strong> whether this sample feature is a known source of batch effect)
</div>
<div align="center" ,="" style="padding:0 2cm">
<table>
<thead>
<tr class="header">
<th align="center">Sample_feature</th>
<th align="center">Type</th>
<th align="center">Num_level</th>
<th align="center">Variable_of_interest</th>
<th align="center">Batch_effect</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Group</td>
<td align="center">factor</td>
<td align="center">12</td>
<td align="center">TRUE</td>
<td align="center">FALSE</td>
</tr>
<tr class="even">
<td align="center">Replicate</td>
<td align="center">factor</td>
<td align="center">3</td>
<td align="center">FALSE</td>
<td align="center">TRUE</td>
</tr>
<tr class="odd">
<td align="center">Hour</td>
<td align="center">integer</td>
<td align="center">12</td>
<td align="center">FALSE</td>
<td align="center">FALSE</td>
</tr>
</tbody>
</table>
</div>
<div align="right">
<em><a href="http://zhezhangsh.github.io/RoCA">Go to project home</a></em>
</div>
</div>
<div id="identification-and-evaluation-of-surrogate-variables" class="section level1">
<h1><span class="header-section-number">3</span> Identification and evaluation of surrogate variables</h1>
<p>The <em>sva()</em> function was used to identify surrogate variables from the original data matrix. Each surrogate variable is responsible for part of the overall data variation, and may or may not be related to known sample features, such as any variables of interest or experiment batch. Since each sample was assigned a value of each surrogate variable by the <em>sva</em> function, these values were used to evaluate the association between surrogate variables and sample features using ANOVA for categoral variables or Pearson’s correlation for numeric variables.</p>
<div style="color:darkblue; padding:0 2cm">
<strong>Table 2</strong> ANOVA p value for the association between surrogate variables and sample features.
</div>
<div align="center" ,="" style="padding:0 1cm">
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="center">SV1</th>
<th align="center">SV2</th>
<th align="center">SV3</th>
<th align="center">SV4</th>
<th align="center">SV5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Group</td>
<td align="center">0.55</td>
<td align="center">0.50</td>
<td align="center">0.800</td>
<td align="center">7.0e-01</td>
<td align="center">0.94</td>
</tr>
<tr class="even">
<td align="left">Replicate</td>
<td align="center">0.11</td>
<td align="center">0.05</td>
<td align="center">0.032</td>
<td align="center">8.5e-05</td>
<td align="center">0.96</td>
</tr>
<tr class="odd">
<td align="left">Hour</td>
<td align="center">0.89</td>
<td align="center">0.77</td>
<td align="center">0.100</td>
<td align="center">3.4e-01</td>
<td align="center">0.96</td>
</tr>
</tbody>
</table>
</div>
<p>The <em>f.pvalue()</em> function was used to run ANOVA tests using the variable(s) of interest and original data matrix, so each gene got an ANOVA p value. The test was then run again after adjusting the data matrix for surrogate variables that were not significantly associated with the surrogate variables (p &lt; 0.01). The goal is to evaluate if the global statistical power was improved after the confounding effect of surrogate variables was removed.</p>
<div align="center">
<img src="figure/p_value_surrogate-1.png" title="plot of chunk p_value_surrogate" alt="plot of chunk p_value_surrogate" width="640px" />
</div>
<div style="color:darkblue; padding:0 2cm">
<strong>Figure 1.</strong> Comparison of the ANOVA p values obtained using the original data matrix and the matrix adjusted by surrogate variables not significantly associated with any variable(s) of interest.
</div>
<div align="right">
<em><a href="http://zhezhangsh.github.io/RoCA">Go to project home</a></em>
</div>
</div>
<div id="adjust-data-for-batch-effect" class="section level1">
<h1><span class="header-section-number">4</span> Adjust data for batch effect</h1>
<p>Since sample feature, <em>Replicate</em>, was known to cause batch effect in the data, the original data matrix was then adjusted to remove its effect using the <a href="http://biostatistics.oxfordjournals.org/content/8/1/118.abstract"><em>ComBat</em></a> method if it is a categoral variable or the limma method if it is a numerical variable</p>
<div align="center">
<img src="figure/p_value_adj-1.png" title="plot of chunk p_value_adj" alt="plot of chunk p_value_adj" width="640px" />
</div>
<div style="color:darkblue; padding:0 2cm">
<strong>Figure 2.</strong> Same plot as <strong>Figure 1</strong>, except that the y-axis p values were based on the data adjusted by the known batch effect variable using the <em>ComBat</em> (categoral) or <em>limma</em> (numeric) method.
</div>
<div align="right">
<em><a href="http://zhezhangsh.github.io/RoCA">Go to project home</a></em>
</div>
</div>
<div id="evaluate-all-variables" class="section level1">
<h1><span class="header-section-number">5</span> Evaluate all variables</h1>
<p>Finally, the confounding or batch effect of all sample features and surrogate variables was evaluated one by one, after removing it from the original data matrix.</p>
<div align="center">
<img src="figure/all_variable_top_ratio-1.png" title="plot of chunk all_variable_top_ratio" alt="plot of chunk all_variable_top_ratio" width="480px" />
</div>
<div style="color:darkblue; padding:0 2cm">
<strong>Figure 3.</strong> After adjusting the original data for each of the sample features or surrogate variables, ANOVA p values were calculated again for each gene. The numbers of significant genes obtaining from each adjusted data matrix were compared to the numbers of genes obtained from the original matrix. The color in this plot represents relative frequency of genes (red = more). Clcik <a href="table/gene_count_adjusted.html">here</a> to view table of gene counts.
</div>
<div align="right">
<em><a href="http://zhezhangsh.github.io/RoCA">Go to project home</a></em>
</div>
<hr />
</div>
<div id="appendix" class="section level1">
<h1><span class="header-section-number">6</span> Appendix</h1>
<p>Check out the <strong><a href="http://zhezhangsh.github.io/RoCA">RoCA home page</a></strong> for more information.</p>
<div id="reproduce-this-report" class="section level2">
<h2><span class="header-section-number">6.1</span> Reproduce this report</h2>
<p>To reproduce this report:</p>
<ol style="list-style-type: decimal">
<li><p>Find the data analysis template you want to use and an example of its pairing YAML file <a href="https://github.com/zhezhangsh/RoCA/wiki/Templates-and-examples">here</a> and download the YAML example to your working directory</p></li>
<li><p>To generate a new report using your own input data and parameter, edit the following items in the YAML file:</p></li>
</ol>
<ul>
<li><em>output</em> : where you want to put the output files</li>
<li><em>home</em> : the URL if you have a home page for your project</li>
<li><em>analyst</em> : your name</li>
<li><em>description</em> : background information about your project, analysis, etc.</li>
<li><em>input</em> : where are your input data, read instruction for preparing them</li>
<li><em>parameter</em> : parameters for this analysis; read instruction about how to prepare input data</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Run the code below within <strong><em>R Console</em></strong> or <strong><em>RStudio</em></strong>, preferablly with a new R session:</li>
</ol>
<pre class="r"><code>if (!require(devtools)) { install.packages(&#39;devtools&#39;); require(devtools); }
if (!require(RCurl)) { install.packages(&#39;RCurl&#39;); require(RCurl); }
if (!require(RoCA)) { install_github(&#39;zhezhangsh/RoCAR&#39;); require(RoCA); }

CreateReport(filename.yaml);  # filename.yaml is the YAML file you just downloaded and edited for your analysis</code></pre>
<p>If there is no complaint, go to the <em>output</em> folder and open the <strong><em>index.html</em></strong> file to view report.</p>
</div>
<div id="session-information" class="section level2">
<h2><span class="header-section-number">6.2</span> Session information</h2>
<pre><code>## R version 3.2.2 (2015-08-14)
## Platform: x86_64-apple-darwin13.4.0 (64-bit)
## Running under: OS X 10.10.5 (Yosemite)
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats4    parallel  stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] sva_3.18.0            genefilter_1.50.0     mgcv_1.8-7           
##  [4] nlme_3.1-121          gplots_3.0.1          DESeq_1.20.0         
##  [7] lattice_0.20-33       locfit_1.5-9.1        Biobase_2.28.0       
## [10] edgeR_3.10.2          limma_3.26.9          DEGandMore_0.0.0.9000
## [13] snow_0.4-1            awsomics_0.0.0.9000   Rnaseq_0.0.0.9000    
## [16] GenomicRanges_1.22.4  GenomeInfoDb_1.6.3    IRanges_2.4.8        
## [19] S4Vectors_0.8.11      BiocGenerics_0.16.1   fpc_2.1-10           
## [22] vioplot_0.2           sm_2.2-5.4            htmlwidgets_0.5      
## [25] DT_0.1                yaml_2.1.13           knitr_1.12.3         
## [28] rmarkdown_0.9.6       RoCA_0.0.0.9000       RCurl_1.95-4.8       
## [31] bitops_1.0-6          devtools_1.11.1      
## 
## loaded via a namespace (and not attached):
##  [1] mclust_5.0.2         Rcpp_0.12.4          mvtnorm_1.0-3       
##  [4] class_7.3-13         gtools_3.5.0         digest_0.6.9        
##  [7] R6_2.1.2             RSQLite_1.0.0        evaluate_0.9        
## [10] highr_0.5.1          httr_1.1.0           zlibbioc_1.14.0     
## [13] diptest_0.75-7       curl_0.9.7           annotate_1.46.1     
## [16] gdata_2.17.0         kernlab_0.9-22       Matrix_1.2-2        
## [19] splines_3.2.2        geneplotter_1.46.0   stringr_1.0.0       
## [22] htmltools_0.3.5      nnet_7.3-10          XML_3.98-1.3        
## [25] withr_1.0.1          MASS_7.3-43          grid_3.2.2          
## [28] jsonlite_0.9.20      xtable_1.7-4         DBI_0.3.1           
## [31] git2r_0.15.0         magrittr_1.5         formatR_1.3         
## [34] KernSmooth_2.23-15   stringi_1.0-1        XVector_0.10.0      
## [37] flexmix_2.3-13       robustbase_0.92-5    RColorBrewer_1.1-2  
## [40] tools_3.2.2          trimcluster_0.1-2    DEoptimR_1.0-3      
## [43] survival_2.38-3      AnnotationDbi_1.30.1 cluster_2.0.3       
## [46] caTools_1.17.1       prabclus_2.2-6       memoise_1.0.0       
## [49] modeltools_0.2-21</code></pre>
<div align="right">
<em><a href="http://zhezhangsh.github.io/RoCA">Go to project home</a></em>
</div>
<hr />
<p><strong>END OF DOCUMENT</strong></p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
