---
title: "tSNE-DBSCAN classification"
author: "Jim Zhang"
date: "2016-12-25"
output:
  html_document:
    number_sections: yes
    self_contained: no
    toc: yes
    toc_float:
      collapsed: no
---

<div style="border:black 1px solid; padding: 0.5cm 0.5cm">
This analysis performs sample classification using high-dimension data. It includes two main steps: 

**The first step** uses the **t-SNE** (t-Distributed Stochastic Neighbor Embedding) to create a 2D or 3D-map from  high dimensional data. The Barnes-Hut version of t-SNE is used to reduce computing time, so it can be run for multiple times. The result of t-SNE run having the lowest Kullback–Leibler (KL) divergence will be used for the next step. 

**The second step** uses the **DBSCAN** method to cluster samples using the t-SNE result from the last step. The two key parameters of DBSCAN, _epsilon neighborhood_ and _minimum cluster size_ are adjusted based on silhouette score to obtain optimal classification.

Additionally, the result of unsupervised clustering is compared to any known sample features to evaluate their association.

</div>

&nbsp;



<div align='right'>_[Go to project home](https://github.com/zhezhangsh/RoCA)_</div> 

# Description

## Project


Classification of immune cells


## Analysis


This analysis uses transcriptome data to classify samples from different immune cells and disease states.


## Samples


3 immune cell types (B, T, and monocyte) from 6 donors, including 3 healthy controls and 3 patients.



<div align='right'>_[Go to project home](https://github.com/zhezhangsh/RoCA)_</div>



<div align='right'>_[Go to project home](https://github.com/zhezhangsh/RoCA)_</div>

# Results

## t-SNE



**t-SNE** (t-Distributed Stochas- tic Neighbor Embedding) is a method of feature reduction that maps high-dimentional data to a 2- or 3-dimensional space. This analysis utilizes the Barnes-Hut version on a data matrix with **18** samples and **25207** features. The method is implemented by the _Rtsne {Rtsne}_ R function. 

On a t-SNE space, the similarities between samples is measured by their overall KL (Kullback–Leibler) divergence. An optimal t-SNE run should have relatively lower KL divergence. Each t-SNE run of this analysis involves the following sub-steps:

  - Run an initial PCA to reduce the number of features to **50**;
  - Calculate the euclidean distance between any two samples to get a similarity score;
  - The distance of each sample to **2** nearest neighbors is fit to a _Cauchy_ distribution, on a **2**-dimensional space;
  - The _Barnes-Hut_ approximation is used to reduce computational complexity, with **theta = 0.5**;
  - The position of samples on the low dimensional space is adjusted for up to **1000** iterations to lower overall KL divergence. 
  
The steps above are re-run for **5** times, and output from the run with the lowest KL divergence is the final result of t-SNE.







<div align='center'> 

```
## Error in switch(options$dev, pdf = ".pdf", jpeg = ".jpeg", ".png"): EXPR must be a length 1 vector
```
</div>

<div style="color:darkblue; padding:0 3cm">
**Figure 1.** The t-SNE program is run repeatedly for 5 times, and the final _Kullback-Leibler_ divergence, or total cost, of the map generated by all runs is summarized in this figure. Click [here](table/kl_divergence.txt) to download the full table of KL divergence.
</div>

<div align='center'> 

```
## Error in switch(options$dev, pdf = ".pdf", jpeg = ".jpeg", ".png"): EXPR must be a length 1 vector
```


```
## Error in switch(options$dev, pdf = ".pdf", jpeg = ".jpeg", ".png"): EXPR must be a length 1 vector
```
</div>

<div style="color:darkblue; padding:0 3cm">
**Figure 2.** t-SNE runs with the highest and the lowest KL divergence. The run with the lowest KL divergence is picked as the final t-SNE results and input to DBSCAN classification.
</div>

<div align='right'>_[Go to project home](https://github.com/zhezhangsh/RoCA)_</div>

## DBSCAN

**DBSCAN** (Density-based spatial clustering of applications with noise) is a sample clustering method based on the density of sample on a multi-dimensional space. This analysis uses the _dbscan {dbscan}_ R implementation of this method. Its input is the result of t-SNE run with the lowest KL divergence and its output is evaluated by the silhouette score of clustered samples. Each DBSCAN run requires the following parameters:

  - **eps** (required): size of the epsilon neighborhood. This analysis uses a iterative procedure to identify the **eps** value maximizing the silhouette score of clustered samples. 
  - **minPts** (required): minimal number of core points (samples) to form a cluster. This analysis tests the **minPts** value from **2** to **9** to identify the optimal **eps/minPts** combination with the highest silhouette score.
  - **search**: nearest neighbor search strategy = "**kdtree**".
  - **bucketSize**: max size of the kd-tree leafs = **10**.
  - **splitRule** rule to split the kd-tree = "**suggest**".
  - **approx**: relative error bound for approximate nearest neighbor searching = **0**.



<div align='center'> 

```
## Error in switch(options$dev, pdf = ".pdf", jpeg = ".jpeg", ".png"): EXPR must be a length 1 vector
```
</div>

<div style="color:darkblue; padding:0 3cm">
**Figure 3.** The average of silhouette scores corresponding to each value of minimal cluster size. The minimal cluster size having the highest score is highlighted in red. 
</div>

The optimal value of **minPts** (minimal number of samples in a cluster) is **2**. The corresponding clustering result of DBSCAN will be used for the rest of this analysis. 

<div style="color:darkblue; padding:0 1cm">
**Table 1** Summarization of clusters identified by DBSCAN using t-SNE output. Click [here](table/dbscan_classification.txt) to download the full table of classification results.
</div>

<div align='center', style="padding:0 1cm"> 


| Cluster_ID|  N| Neighbors| Width_Mean| Width_Median| Width_Min| Width_1stQu| Width_3rdQu| Width_Max|
|----------:|--:|---------:|----------:|------------:|---------:|-----------:|-----------:|---------:|
|  Cluster_0|  0|          |        NaN|           NA|        NA|          NA|          NA|        NA|
|  Cluster_1|  3|       2;4|       0.85|         0.85|     0.810|        0.83|        0.87|      0.89|
|  Cluster_2|  3|         1|       0.88|         0.87|     0.870|        0.87|        0.88|      0.90|
|  Cluster_3|  4|         6|       0.52|         0.64|     0.096|        0.50|        0.66|      0.70|
|  Cluster_4|  3|         6|       0.80|         0.81|     0.770|        0.79|        0.82|      0.83|
|  Cluster_5|  3|         2|       0.92|         0.92|     0.900|        0.91|        0.92|      0.93|
|  Cluster_6|  2|         3|       0.81|         0.81|     0.790|        0.80|        0.82|      0.83|


</div>

<div align='center'> 

```
## Error in switch(options$dev, pdf = ".pdf", jpeg = ".jpeg", ".png"): EXPR must be a length 1 vector
```
</div>

<div style="color:darkblue; padding:0 3cm">
**Figure 4.** Samples are clustered via DBSCAN using the results from t-SNE run with the lowest KL divergence. Samples in the same clusters have the same colors. **Cluster_0** is made of samples cannot be clustered. 
</div>

<div align='right'>_[Go to project home](https://github.com/zhezhangsh/RoCA)_</div>

## Cluster-feature association

If the samples have been previously labeled with their known features, such as genotype, treatment and disease state, the agreement between these features and DBSCAN classification can be evaluated to discover potential feature-classification association. 





<div style="color:darkblue; padding:0 0.5cm">
**Table 2** Summary of cluster-feature association.

 - _Num_Group_: Number of sample groups according to the feature; 
 - _Rand_: Rand index; _C_Rand_: corrected RAND index; 
 - _ChiSq_: Chi-squared test statistics; 
 - _P_ChiSq_: p value of Chi-square test; 
 - _Count_Expected_: table with expected counts within each cell of the contingency table;
 - _Count_Observed_: table with observed counts within each cell of the contingency table; 
 - _Obs/Exp_: table with expected vs. observed counts.
</div>

<div align='center', style="padding:0 0.5cm"> 


|Feature | Num_Group| Rand| C_Rand| ChiSq| P_ChiSq|                               Count_Expected|                               Count_Observed|                                   Obs/Exp|
|:-------|---------:|----:|------:|-----:|-------:|--------------------------------------------:|--------------------------------------------:|-----------------------------------------:|
|Group   |         6| 0.97|   0.85|    81|  0.0001|   [Table](table/expected_cluster2Group.html)|   [Table](table/observed_cluster2Group.html)|   [Table](table/ratio_cluster2Group.html)|
|Cell    |         3| 0.83|   0.51|    36|  0.0001|    [Table](table/expected_cluster2Cell.html)|    [Table](table/observed_cluster2Cell.html)|    [Table](table/ratio_cluster2Cell.html)|
|Disease |         2| 0.61|   0.19|    15|  0.0027| [Table](table/expected_cluster2Disease.html)| [Table](table/observed_cluster2Disease.html)| [Table](table/ratio_cluster2Disease.html)|
|Donor   |         6| 0.76|  -0.14|    18|  1.0000|   [Table](table/expected_cluster2Donor.html)|   [Table](table/observed_cluster2Donor.html)|   [Table](table/ratio_cluster2Donor.html)|


</div>

<div align='center'>

```
## Error in switch(options$dev, pdf = ".pdf", jpeg = ".jpeg", ".png"): EXPR must be a length 1 vector
```
</div>

<div style="color:darkblue; padding:0 3cm">
**Figure 5.** The contingency table of the clusters and the known sample feature has the most significant association based on Chi-square test. The numbers are the counts of samples at each intersect. The colors indicate the ratios of observed over expected sample counts.
</div>

<div align='right'>_[Go to project home](https://github.com/zhezhangsh/RoCA)_</div>

***

<!-- Keep this section unchanged for all RoCA templates -->
# Appendix 

Check out the **[RoCA home page](http://zhezhangsh.github.io/RoCA)** for more information.  

## Reproduce this report

To reproduce this report: 

  1. Find the data analysis template you want to use and an example of its pairing YAML file  [here](https://github.com/zhezhangsh/RoCA/wiki/Templates-and-examples) and download the YAML example to your working directory

  2. To generate a new report using your own input data and parameter, edit the following items in the YAML file:

    - _output_        : where you want to put the output files
    - _home_          : the URL if you have a home page for your project
    - _analyst_       : your name
    - _description_   : background information about your project, analysis, etc.
    - _input_         : where are your input data, read instruction for preparing them
    - _parameter_     : parameters for this analysis; read instruction about how to prepare input data

  3. Run the code below within ***R Console*** or ***RStudio***, preferablly with a new R session:


```r
if (!require(devtools)) { install.packages('devtools'); require(devtools); }
if (!require(RCurl)) { install.packages('RCurl'); require(RCurl); }
if (!require(RoCA)) { install_github('zhezhangsh/RoCAR'); require(RoCA); }

CreateReport(filename.yaml);  # filename.yaml is the YAML file you just downloaded and edited
```

If there is no complaint, go to the _output_ folder and open the ***index.html*** file to view report. 

## Session information


```
## R version 3.2.2 (2015-08-14)
## Platform: x86_64-apple-darwin13.4.0 (64-bit)
## Running under: OS X 10.10.5 (Yosemite)
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats4    grid      stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] flexclust_1.3-4     modeltools_0.2-21   lattice_0.20-33    
##  [4] cluster_2.0.4       e1071_1.6-7         gplots_3.0.1       
##  [7] dbscan_0.9-8        Rtsne_0.11          plotly_4.5.2       
## [10] ggplot2_2.1.0       htmlwidgets_0.7     DT_0.2             
## [13] awsomics_0.0.0.9000 yaml_2.1.13         rmarkdown_1.0      
## [16] knitr_1.14          RoCA_0.0.0.9000     RCurl_1.95-4.8     
## [19] bitops_1.0-6        devtools_1.12.0    
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_0.12.6        highr_0.6          formatR_1.4       
##  [4] plyr_1.8.4         class_7.3-14       base64enc_0.1-3   
##  [7] tools_3.2.2        digest_0.6.10      jsonlite_1.0      
## [10] evaluate_0.9       memoise_1.0.0      tibble_1.1        
## [13] gtable_0.2.0       viridisLite_0.1.3  DBI_0.4-1         
## [16] parallel_3.2.2     withr_1.0.2        stringr_1.0.0     
## [19] dplyr_0.5.0        httr_1.2.1         caTools_1.17.1    
## [22] gtools_3.5.0       R6_2.1.2           gdata_2.17.0      
## [25] purrr_0.2.2        tidyr_0.5.1        magrittr_1.5      
## [28] scales_0.4.0       htmltools_0.3.5    assertthat_0.1    
## [31] colorspace_1.2-6   KernSmooth_2.23-15 stringi_1.1.1     
## [34] lazyeval_0.2.0     munsell_0.4.3
```

<div align='right'>_[Go to project home](https://github.com/zhezhangsh/RoCA)_</div>

***
_END OF DOCUMENT_
