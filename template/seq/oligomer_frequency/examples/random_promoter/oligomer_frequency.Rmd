---
title: "Frequency of oligomers in DNA sequences"
author: "`r if (exists('yml')) yml$analyst else 'Jim Zhang'`"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
    self_contained: no
    toc: yes
    toc_float:
      collapsed: no
---

<div style="border:black 1px solid; padding: 0.5cm 0.5cm">
This analysis reports of the frequency of oligomers in DNA sequences and compare the observed frequency to expected frequency. 

  - Oligomers of the same length are analyzed together.
  - The length of the oligomers can range from 2 to 8, depending on the user-specified values. 
  - The expected frequency will be calculated according to the overall base frequency in DNA sequences (A, C, G, or T only).
  - Over- or under-representation of oligomers is calculated as the ratio of their observed frequency over expected frequency, and tested by Fisher's exact test.
  - For each oligomer, skewness of its occurances at relative positions of DNA sequences is tested by Kolmogorov-Smirnov test, and its enrichment with the center or both ends of the sequences is tested by Fisher's exact test.
</div>

&nbsp;


```{r global_setup, eval=TRUE, include=FALSE}
name.yaml <- 'oligomer_frequency.yaml'; 
name.packages <- c('rmarkdown', 'knitr', 'kableExtra', 'yaml', 'DT', 'htmlwidgets', 
                   'Biostrings', 'GenomicRanges', 'RoCA', 'awsomics'); 
name.subfolders <- c('path.input'='input', 'path.r'='R', 'path.fig'='figure', 'path.tbl'='table'); # 

## Default knitr parameters
knitr::opts_chunk$set(dpi=300, dev=c('png', 'pdf'), echo=FALSE, warning=FALSE, message=FALSE);
if (!require(devtools)) { install.packages('devtools'); require(devtools); }
if (!require(RCurl)) { install.packages('RCurl'); require(RCurl); }
if (!require(RoCA)) { install_github('zhezhangsh/RoCAR'); require(RoCA); }

## Load required R packages
loaded <- LoadPackage(name.packages);
if (length(loaded[!loaded])) stop('Error: failed to load package(s) ', paste(names(loaded[!loaded]), collapse=', '));

## By default, before knitting this R Markdown file, the YAML file pairing it has been loaded.
## But, the developer can also provide the option to load the YAML file on the fly.
## So, the template can be run using the "Knit HTML" button in RStudio
if (!exists('yml'))                   # if the 'yml' variable doesn't exist yet, create it by loading the YAML file
	if (file.exists(name.yaml))         # assume the pairing YAML file exists in the current folder with the same name
		yml<-yaml.load_file(name.yaml);   # rename the YAML file to fit this template

prms <- yml$parameter;

## Generate directory and sub-directories where the output files will be
f <- GenerateFolder(yml$output, name.subfolders);
path <- yml$output;
for (i in 1:length(name.subfolders)) assign(names(name.subfolders)[i], f[name.subfolders[i]]); 

## Automatical figure/table ordering
OrderFigure(reset=TRUE);
OrderTable(reset=TRUE);

## URL to project home
## Use this line to add a link to project home in the report: `r home.url`
home.url <- Link2Home(yml$home);
```

`r home.url`

# Description

`r WriteDescription(yml$description)`

`r home.url`

```{r load_data, include=FALSE}
seq <- ImportVector(DownloadFile(yml$input$seq, path.input));
seq <- DNAStringSet(seq);

nms <- names(seq);
if (is.null(nms)) nms <- paste('Seq', 1:length(seq), sep='_'); 
ind <- which(is.na(nms) | nms=='');
if (length(ind) > 0) nms[ind] <- paste('Seq', ind, sep='_');
names(seq) <- nms;

wid <- width(seq);
names(wid) <- names(seq);

saveRDS(seq, paste0(path.r, '/sequence.rds'));
```

# Results

## DNA sequences

```{r summary_seq, include=FALSE}
frq <- alphabetFrequency(seq)[, 1:4];
gc  <- round(100*rowSums(frq[, 2:3])/rowSums(frq), 2);
cg1 <- sapply(gregexpr2('CG', seq), function(ind) length(ind[ind>0]));
cg2 <- sapply(gregexpr2('GC', seq), function(ind) length(ind[ind>0]));
cpg <- 100*(cg1+cg2)/(width(seq)-1);
tbl <- rbind(round(summary(wid), 1), round(summary(gc), 2)); 
rownames(tbl) <- c('Length (bp)', 'GC (%)');
```

`r OrderTable()` Length and GC content of **`r length(seq)`** DNA sequences.

`r kable(tbl, align=rep('c', ncol(tbl))) %>% kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width=FALSE)`

`r home.url`

## Oligo frequency

```{r function, include=FALSE}
compareFreq <- function(seq, len) {
  bas <- c('A', 'C', 'G', 'T');
  frq <- alphabetFrequency(seq)[, bas];
  prb <- colSums(frq)/sum(frq);

  cmb <- sapply(1:len, function(l) rep(rep(bas, each=4^(len-l)), 4^(l-1)));
  cmb <- apply(cmb, 1, function(x) paste(x, collapse=''));
  exp <- sapply(1:len, function(l) rep(rep(prb, each=4^(len-l)), 4^(l-1)));
  exp <- 2^(rowSums(log2(exp)));
  cnt <- vcountPDict(PDict(cmb), seq); 
  ttl <- sum(cnt);
  obs <- rowSums(cnt)/ttl; # Observed frequency
  pvl <- suppressWarnings(sapply(1:length(cmb), function(i) prop.test(sum(cnt[i, ]), ttl, exp[i])$p.value[1]));
  
  tbl <- cbind(rowSums(cnt), 100*exp, 100*obs, obs/exp, pvl);
  rownames(tbl) <- cmb;
  colnames(tbl) <- c('count', 'expected(%)', 'observed(%)', 'ratio', 'pvalue');
  
  rownames(frq) <- names(seq);
  colnames(cnt) <- names(seq);
  rownames(cnt) <- cmb;
  list(frequency=frq, count=cnt, stat=tbl);
}
```

```{r, include=FALSE}
rng <- sort(unlist(prms$length));
rng[1] <- max(2, rng[1]);
rng[2] <- min(8, rng[2]);

fll <- lapply(rng[1]:rng[2], function(len) compareFreq(seq, len));
names(fll) <- paste0(rng[1]:rng[2], 'mer');

sapply(names(fll), function(nm) {
  tbl <- fll[[nm]][[3]];
  CreateDatatable(FormatNumeric(tbl), paste0(path.tbl, '/', paste0('stat_', nm)));
  write.csv(tbl, paste0(path.tbl, '/', paste0('stat_', nm, '.csv')));
})->x;

# Summary
smm <- sapply(fll, function(x) {
  c <- rowSums(x$count);
  s <- x$stat; 
  r <- cor(s[, 2], s[, 3]);
  p <- shapiro.test(sample(s[, 4], min(5000, nrow(s))))$p.value[[1]];
  c(length(c), length(c[c>0]), nrow(s[s[, 5]<=prms$selection$pvalue, , drop=FALSE]), r, p);
});
smm <- t(smm);

sel <- sapply(fll, function(x) {
  s <- x$stat;
  s <- s[s[, 5]<=prms$selection$pvalue, , drop=FALSE];   
  if (nrow(s) == 0) '' else {
    s <- s[rev(order(s[, 4])), , drop=FALSE];
    s <- rownames(s)[1:min(nrow(s), prms$selection$number)];
    paste(s, collapse=';');
  }
});
tbl <- data.frame(rownames(smm), smm, sel, stringsAsFactors = FALSE);
colnames(tbl) <- c("Length", 'N_Theoretical', 'N_Observed', 'N_Significant', 'Correlation', 'P_Normality', 
                   paste('Top', prms$selection$number));
tbl[[1]] <- paste0('[', tbl[[1]], '](table/stat_', names(fll), '.html)');
saveRDS(fll, paste0(path.r, '/full_result.rds'));
```

`r OrderTable()` Summary of oligomer combinations. 

  - **Length**: length of the oligomers; click link to view details of all combinations
  - **N_Theoretical**: total number of combinations in theory
  - **N_Observed**: number of combinations observed in sequences
  - **N_Significant**: number of combinations signifantly over- or under-represented in sequences according to proportional test
  - **Correlation**: correlation between the expected and observed frequency of all combinations
  - **P_Normality**: p value of the normality test on the log-ratio of observed over expected frequencies
  - **`r colnames(tbl)[ncol(tbl)]`**: top `r prms$selection$number` most over-represented combination(s) with p value of proportional test less than `r prms$selection$pvalue`
  
`r kable(FormatNumeric(tbl), row.names=FALSE) %>% kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width=FALSE)`

`r home.url`


***

# Appendix 

Check out the **[RoCA home page](http://zhezhangsh.github.io/RoCA)** for more information.  

## Reproduce this report

To reproduce this report: 

  1. Find the data analysis template you want to use and an example of its pairing YAML file  [here](https://github.com/zhezhangsh/RoCA/wiki/Templates-and-examples) and download the YAML example to your working directory

  2. To generate a new report using your own input data and parameter, edit the following items in the YAML file:

    - _output_        : where you want to put the output files
    - _home_          : the URL if you have a home page for your project
    - _analyst_       : your name
    - _description_   : background information about your project, analysis, etc.
    - _input_         : where are your input data, read instruction for preparing them
    - _parameter_     : parameters for this analysis; read instruction about how to prepare input data

  3. Run the code below within ***R Console*** or ***RStudio***, preferablly with a new R session:

```{r reproduce_report, eval=FALSE, echo=TRUE}
if (!require(devtools)) { install.packages('devtools'); require(devtools); }
if (!require(RCurl)) { install.packages('RCurl'); require(RCurl); }
if (!require(RoCA)) { install_github('zhezhangsh/RoCAR'); require(RoCA); }

CreateReport(filename.yaml);  # filename.yaml is the YAML file you just downloaded and edited
```

If there is no complaint, go to the _output_ folder and open the ***index.html*** file to view report. 

## Session information

```{r session_info, echo=FALSE}
sessionInfo(); 
```

`r home.url`

***
_END OF DOCUMENT_
